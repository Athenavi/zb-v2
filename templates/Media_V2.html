<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="keywords" content=""/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="">
    <title>{{ title }}</title>
    <link rel="shortcut icon" type="image/ico" href="/favicon.ico">
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-mousewheel/3.1.9/jquery.mousewheel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.js"></script>
    <link rel="stylesheet" href="/static/css/dropzone.css">
    <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.css" rel="stylesheet">
    <style>
        .checkbox-container {
            z-index: 10;
        }

        .file-checkbox:checked {
            accent-color: #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-100">
<!-- Navigation Bar -->
{% from 'header.html' import SimpleHeader %}
{{ SimpleHeader(title) }}

<header class="bg-white rounded-lg shadow mb-6 p-4">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold"><a href="/">ğŸ </a> åª’ä½“æ–‡ä»¶</h1>
        <div class="flex items-center space-x-4">
            <!-- æ·»åŠ ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <button id="edit-mode-btn" class="text-white px-4 py-2 rounded hover:bg-blue-600"
                    onclick="toggleEditMode()">ç¼–è¾‘æ¨¡å¼
            </button>
            <!-- æ·»åŠ æ‰¹é‡åˆ é™¤æŒ‰é’® (é»˜è®¤éšè—) -->
            <button id="batch-delete-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden"
                    onclick="batchDelete()">åˆ é™¤é€‰ä¸­é¡¹
            </button>
        </div>
        <div>
            <a href="{{ url_for('media', user_name=username, page=1) }}"
               class="ml-2 text-blue-500 hover:underline">ä»…å›¾ç‰‡</a>
            <a href="{{ url_for('media', user_name=username, page=1,type='video') }}"
               class="ml-2 text-blue-500 hover:underline">ä»…è§†é¢‘</a>
        </div>
    </div>
</header>
<div id="result-message" class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-lg"></div>
<main class="content bg-white rounded-lg shadow p-4">
    <!-- File Upload Section -->
    <form action="/upload_file" class="dropzone border-dashed border-2 border-gray-400 rounded-lg p-8 mb-6"
          method="POST" enctype="multipart/form-data" id="myDropzone"></form>
    <script src="/static/js/dropzone.js"></script>
    <script>
        // Initialize Dropzone
        Dropzone.options.myDropzone = {
            acceptedFiles: '.jpg, .png, .webp, .jfif, .pjpeg, .jpeg, .pjp, .mp4, .xmind',
            maxFilesize: 60,
            maxFiles: 3,
            dictFileTooBig: 'è¶…å‡ºæ–‡ä»¶å¤§å°é™åˆ¶ ({{filesize}}MB). æœ€å¤§æ–‡ä»¶å¤§å°: {{maxFilesize}}MB.',
            dictInvalidFileType: 'æ— æ•ˆçš„æ–‡ä»¶ç±»å‹. ä»…æ”¯æŒ JPG, PNG, WEBP, JFIF, PJPEG, JPEG, PJP, MP4 æ–‡ä»¶ã€‚',
            init: function () {
                this.on('success', function (file, response) {
                    console.log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                });
                this.on('error', function (file, errorMessage) {
                    console.log('æ–‡ä»¶ä¸Šä¼ é”™è¯¯: ' + errorMessage);
                });
            },
            withCredentials: true,
        };
    </script>
    <hr class="my-4">
    <!-- Media Display Section -->
    <section>
        <ul class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for id, img in imgs %}
                <li class="group relative">
                    <div class="checkbox-container absolute top-2 left-2 hidden">
                        <input type="checkbox" class="file-checkbox w-5 h-5"
                               data-file-id="{{ id }}"
                               onchange="updateSelectionCount()">
                    </div>
                    <div class="bg-gray-200 rounded-lg overflow-hidden shadow">
                        <a href="/{{ img }}" class="fancybox" data-fancybox="gallery"
                           title="{{ img.split('\\')[-1] }}">
                            <img src="/thumb/{{ img }}" alt=""
                                 class="w-full h-40 object-cover"/>
                        </a>
                    </div>
                </li>
            {% endfor %}
            {% for id,video in videos %}
                <li class="group relative">
                    <div class="checkbox-container absolute top-2 left-2 hidden">
                        <input type="checkbox" class="file-checkbox w-5 h-5"
                               data-file-id="{{ id }}"
                               onchange="updateSelectionCount()">
                    </div>
                    <div class="bg-gray-200 rounded-lg overflow-hidden shadow">
                        <a class="card-link"
                           onclick="startVideo('{{ video.replace('\\', '/')|escape }}')">
                            <button class="btn btn-primary"
                                    onclick="copyVideoURL('{{ video.replace('\\', '/')|escape }}')">
                                copy
                            </button>
                            <img src="/V-thumb/{{ video }}.png" alt=""
                                 class="w-full h-40 object-cover"/>
                        </a>
                    </div>
                </li>
            {% endfor %}
        </ul>
    </section>

    <!-- Pagination Section -->
    <div class="pagination my-4">
        <div class="flex justify-between my-4">
            {% if has_previous_page and mediaType %}
                <a href="{{ url_for('media', user_name=username, page=current_page-1, type=mediaType) }}"
                   class="btn btn-secondary">Previous</a>
            {% endif %}
            {% if has_next_page and mediaType %}
                <a href="{{ url_for('media', user_name=username, page=current_page+1, type=mediaType) }}"
                   class="btn btn-secondary">Next</a>
            {% endif %}
        </div>
    </div>
</main>

<!-- Footer -->
{% from 'footer.html' import SimpleFooter %}
{{ SimpleFooter(title, beian) }}

<!-- Video Popup -->
<div id="video-popup" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center">
    <div class="video-wrapper">
        <video id="video-image" src="" controls class="max-w-80 max-h-80 border-2 border-white rounded"></video>
        <button class="btn btn-primary mt-2" onclick="closeVideo()">å…³é—­</button>
    </div>
</div>

<!-- Xmind Popup -->
<div id="xmind-popup" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center">
    <div class="xmind-wrapper">
        <button class="btn btn-primary" onclick="closeXmind()">å…³é—­é¢„è§ˆ</button>
    </div>
</div>

<script src="/static/js/media.js"></script>
<script src="/static/js/prewXmind.js"></script>
<script>
    function copyImgURL(img) {
        const URL = "{{ domain }}" + "zyImg/{{ username }}/" + img;
        navigator.clipboard.writeText(URL).then(function () {
            alert("å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼Œå¯åœ¨åšå®¢ä¸­ä½¿ç”¨æ­¤å¤–é“¾å›¾ç‰‡");
        }).catch(function (error) {
            alert("å¤åˆ¶å¤±è´¥ï¼š" + error);
        });
    }

    function copyVideoURL(video) {
        const URL = "{{ domain }}" + "zyVideo/{{ username }}/" + video;
        navigator.clipboard.writeText(URL).then(function () {
            alert("å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼Œå¯åœ¨åšå®¢ä¸­ä½¿ç”¨æ­¤å¤–é“¾è§†é¢‘");
        }).catch(function (error) {
            alert("å¤åˆ¶å¤±è´¥ï¼š" + error);
        });
    }

    function copyXmindURL(xmind) {
        const URL = "{{ domain }}" + "blog/f/{{ username }}/" + xmind;
        navigator.clipboard.writeText(URL).then(function () {
            alert("å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼Œå¯åœ¨åšå®¢ä¸­ä½¿ç”¨æ­¤å¤–é“¾ Xmind");
        }).catch(function (error) {
            alert("å¤åˆ¶å¤±è´¥ï¼š" + error);
        });
    }

    function startVideo(video) {
        const videoSrc = `/video/` + video;
        document.getElementById("video-image").src = videoSrc;
        document.getElementById("video-popup").classList.remove("hidden");
    }
</script>
<script>
    // æ–°å¢JavaScripté€»è¾‘
    let editMode = false;

    function toggleEditMode() {
        editMode = !editMode;
        const checkboxes = document.querySelectorAll('.checkbox-container');
        const batchBtn = document.getElementById('batch-delete-btn');
        const editBtn = document.getElementById('edit-mode-btn');

        checkboxes.forEach(checkbox => {
            checkbox.style.display = editMode ? 'block' : 'none';
        });
        batchBtn.classList.toggle('hidden', !editMode);
        editBtn.textContent = editMode ? 'é€€å‡ºç¼–è¾‘' : 'ç¼–è¾‘æ¨¡å¼';
    }

    function updateSelectionCount() {
        const selected = document.querySelectorAll('.file-checkbox:checked');
        const batchBtn = document.getElementById('batch-delete-btn');
        batchBtn.textContent = `åˆ é™¤é€‰ä¸­é¡¹ (${selected.length})`;
    }

    async function batchDelete() {
        const ids = Array.from(document.querySelectorAll('.file-checkbox:checked'))
            .map(checkbox => checkbox.dataset.fileId);

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ–‡ä»¶
        if (ids.length === 0) {
            showResultMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶', 'yellow');
            return;
        }

        try {
            const response = await fetch(`/media?file-id-list=${ids.join(',')}`, {
                method: 'DELETE',
                credentials: 'include',
            });

            const result = await response.json();
            if (response.ok) {
                showResultMessage(`æˆåŠŸåˆ é™¤ ${result.deleted_count} ä¸ªæ–‡ä»¶`, 'green');
                // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°åˆ—è¡¨
                setTimeout(() => location.reload(), 1500);
            } else {
                showResultMessage(result.message || 'åˆ é™¤å¤±è´¥', 'red');
            }
        } catch (error) {
            showResultMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message, 'red');
        }
    }

    function showResultMessage(text, colorClass) {
        const div = document.getElementById('result-message');
        div.className = `${colorClass} bg-${colorClass}-100 border-${colorClass}-400 text-${colorClass}-700`;
        div.textContent = text;
        div.classList.remove('hidden');
        setTimeout(() => div.classList.add('hidden'), 3000);
    }
</script>
</body>
</html>
